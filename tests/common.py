import aresponses
from homeassistant.const import CONF_IP_ADDRESS, CONF_PASSWORD
from homeassistant.core import HomeAssistant
from pytest_homeassistant_custom_component.common import load_fixture, MockConfigEntry

from custom_components.candy import DOMAIN, CONF_KEY_USE_ENCRYPTION

TEST_IP = "192.168.0.66"
TEST_ENCRYPTION_KEY_EMPTY = ""
TEST_ENCRYPTION_KEY = "fbfjlbmmfklfaikm"
TEST_ENCRYPTED_HEX_RESPONSE = """
1D6F6C634E11190C121E1F2A001F0A19140B050F4E5816606C62654436002D043516071E19114F57445B4E4A6C636264442714184E584F5D4447616C6860492007010E270840574F5749406B6B60624F361044504E534F416B61656F4339193D0E405C485C4041606C626544311B2802020744504E535E5B4447616C6860493E2A07100F0040574F5649406B6B60624F32070B1A4E584F595649406B6B60624F35120F043F124F5744534E4A6C636264442D161E5D40574F5649406B6B60624F291212584E584F5D4447616C686049221616554856405D4F4A66666F684B241D125644504E524F416B61656F43261B1953405C485C4041606C6265442E191F5B4458445A4E4E60676F624E29111D5C4F5C405648406F67646F49231615514957445244466168646444241C12584B514F56404A67666B644F351F09070C4B514F56404A67666B644F221915324353495D444E6B60656B4F2903073A070D4B514F56404A67666B644F340E013208040E4F5C40545958524F416B61656F433B0E0E0F1203230840574F5649406B6B60624F2A03080D4E584F5C4447616C6860492B0F0E0A384E584F5D4447616C686049290F11320F1F16220344514E56434566676F6B442E05113908151F3E03124B514F56404A67666B644F250309050A3C1B3E1203120F4E584F5D4447616C68604939563544504E524F416B61656F433D223A4458445A4E4E60676F624E32513B495744524446616864644405190B274B514F56404A67666B644F13050E204353495D444E6B60656B4F1808092F445B4B5B4F4A6F6C6365402319053C4E5C43585C59444E6B60656B4F23120828445B4B5D4F4A6F6C636540000212384E5C435949416B686F634E233D3E090D0A445B4B5B4F4A6F6C6365402C3D350D1E03104B514F5053505D5D4041606C62654402010A1F122E44504E524F606C62116B6B14
"""
TEST_UNENCRYPTED_HEX_RESPONSE = """
7B0D0A0922737461747573466F726E6F223A7B0D0A090922537461746F57694669223A2230222C0D0A090922436F646963654572726F7265223A224530222C0D0A0909225265636970654964223A2230222C0D0A09092252656369706553746570223A2230222C0D0A090922537461727453746F70223A2230222C0D0A0909225061757361223A2230222C0D0A0909225369637572657A7A6142616D62696E69223A2230222C0D0A09092253656C6574746F7265223A2230222C0D0A09092250726F6772616D223A2230222C0D0A09092254656D70536574223A2230222C0D0A09092254656D7052656164223A22323130222C0D0A09092254656D705365745261676769756E7461223A2230222C0D0A09092244656C61795374617274223A2230222C0D0A09092252656D61696E696E6754696D6550726F6772223A223635353335222C0D0A0909226F7261223A223135222C0D0A0909226D696E223A223232222C0D0A090922736563223A223138222C0D0A0909224657766572223A2230303141222C0D0A0909227473223A2230220D0A097D0D0A7D
"""


def status_response(filename):
    return aresponses.Response(
        text=load_fixture(filename),
        content_type="text/html"  # Shame on Candy, but this is how the real API responds
    )


async def init_integration(hass: HomeAssistant, aioclient_mock, status_response: str):
    entry = MockConfigEntry(
        domain=DOMAIN,
        unique_id="123-456",
        data={
            CONF_IP_ADDRESS: "192.168.0.66",
            CONF_KEY_USE_ENCRYPTION: False,
            CONF_PASSWORD: "",
        }
    )

    aioclient_mock.get(f"http://{TEST_IP}/http-read.json?encrypted=0", text=status_response)

    entry.add_to_hass(hass)
    await hass.config_entries.async_setup(entry.entry_id)
    await hass.async_block_till_done()
